let splide;
let splideInitialized = false;
const $cartPopupWrapper = $("[data-cart-popup-wrapper]");

const cartPopupClasses = {
  backdrop: "cart-popup-backdrop",
  cartPopupBody: "cart-popup__body",
  withItems: "with-items",
  blank: "blank",
  hidden: "cart-popup-wrapper--hidden",
};
const $cartPopupItemWrapper = $(".cart-popup-item-wrapper");

const $cartPopupSelectors = {
  $backdrop: $(`.${cartPopupClasses.backdrop}`),
  $cartPopupBodyBlank: $(`.${cartPopupClasses.cartPopupBody}.${cartPopupClasses.blank}`),
  $cartPopupBodyWithItems: $(`.${cartPopupClasses.cartPopupBody}.${cartPopupClasses.withItems}`),
};

$cartPopupSelectors.$backdrop.click(() => {
  hideCartPopup();
});

function hideCartPopup() {
  // $cartPopupWrapper.css({ transition: "initial" });
  $cartPopupWrapper.prepareTransition().addClass(cartPopupClasses.hidden);
  $cartPopupSelectors.$backdrop.css({ display: "none" });

  // calculateCartTotals();
  // updateCartTotals();
  cartOpened = false;
     //$('html, body').css({'overflow':'auto'}); 
     $('html, body').css({'overflow':''}); 
}

function showCartPopup() {
  
  if (!cartFilled) {
    cartFilled = true;
    fillCartWithItems(cart.items);
    cartPopupUpsellSetLoading();
    cartPopupUpsellPopulate();
  }
  else {
    refreshCartUpsell();
  }


  $cartPopupWrapper.on("transitionend", (event) => {
    // TOD:
    // Must initialize the slider AFTER cart is loaded, only the first time
    // Because otherwise it will BUUUUUUUG
    // All sliders BUUUG on transitions
    if (!splideInitialized) {
      splide = new Splide(".cart-upsell-splide-container", {
        type: "slide",
        waitForTransition: true,
        swipeDistanceThreshold: 250,
        clones: 0, //1 for no slones
        pagination: false,
      });
      
      splide.on("mounted", () => {
        if (!cartPopupIsUpsellEmpty()) {
          $(document).trigger(cartEvents.upsell.upsellIsNoLongerEmpty);

          if (upsellItemsAvailable - upsellItemsInCart > 1) {
            cartPopupUpsellDisablePrevArrow();
            cartPopupUpsellEnableNextArrow();
          } else {
            cartPopupUpsellDisablePrevArrow();
            cartPopupUpsellDisableNextArrow();
          }
      } else{
   		  $(document).trigger(cartEvents.upsell.upsellIsEmpty)
      }
      });

      splide.on("moved", (newIndex) => {
        const { slides } = splide.Components.Elements;

        if (slides.length === 1) {
          cartPopupUpsellDisableNextArrow();
          cartPopupUpsellDisablePrevArrow();
          return;
        }

        if (newIndex === 0) {
          cartPopupUpsellDisablePrevArrow();
          cartPopupUpsellEnableNextArrow();
          return;
        }

        if (newIndex === slides.length - 1) {
          cartPopupUpsellDisableNextArrow();
          cartPopupUpsellEnablePrevArrow();
          return;
        }

        cartPopupUpsellEnableNextArrow();
        cartPopupUpsellEnablePrevArrow();
      });

      splide.mount();

      cartPopupUpsellSetLoaded();

      splideInitialized = true;
    }
  });

  $cartPopupWrapper.prepareTransition().removeClass(cartPopupClasses.hidden);
  $cartPopupSelectors.$backdrop.css({ display: "block" });

  cartOpened = true;
       $('html, body').css({'overflow':'hidden'}); 

}


function setCartPopupWithItems() {
  $cartPopupSelectors.$cartPopupBodyWithItems.css({ display: "" });
  $cartPopupSelectors.$cartPopupBodyBlank.css({ display: "none" });
}

function setCartPopupBlank() {
  $cartPopupSelectors.$cartPopupBodyWithItems.css({ display: "none" });
  $cartPopupSelectors.$cartPopupBodyBlank.css({ display: "flex" });
}

function fillCartWithItems(items) {
  items.forEach((item) => {
    cartPopupAddItem(item);
  });
}

function attachOnClicksToCartItemControls(item) {
  $itemSelectors.$increaseQuantity(item.key).click((e) => {
    $itemSelectors.$increaseQuantity(item.key).trigger(cartEvents.item.increaseQty, { itemKEY: item.key });
  });
  $itemSelectors.$increaseQuantity(item.key).keyup((e) => {
    e.preventDefault();
    if(e.key === 'Enter'){
    	$itemSelectors.$increaseQuantity(item.key).trigger(cartEvents.item.increaseQty, { itemKEY: item.key});
    }
  });
  
  $itemSelectors.$decreaseQuantity(item.key).click(() => {
    $itemSelectors.$increaseQuantity(item.key).trigger(cartEvents.item.decreaseQty, { itemKEY: item.key });
  });

  $itemSelectors.$decreaseQuantity(item.key).keyup((e) => {
    e.preventDefault();
    if(e.key === 'Enter'){
   	 $itemSelectors.$increaseQuantity(item.key).trigger(cartEvents.item.decreaseQty, { itemKEY: item.key });
    }
  });

  $itemSelectors.$remove(item.key).click(() => {
    $itemSelectors.$increaseQuantity(item.key).trigger(cartEvents.item.remove, { itemKEY: item.key });
  });
  $itemSelectors.$remove(item.key).keyup((e) => {
    e.preventDefault();
    if(e.key === 'Enter'){
    	$itemSelectors.$increaseQuantity(item.key).trigger(cartEvents.item.remove, { itemKEY: item.key });
    }
  });
}

function cartPopupItemLoading(itemKEY) {
  $itemSelectors.$itemByKey(itemKEY).css({ pointerEvents: "none" });
  $itemSelectors.$itemByKey(itemKEY).css({ opacity: 0.5 });
}

function cartPopupItemLoaded(itemKEY) {
  $itemSelectors.$itemByKey(itemKEY).css({ pointerEvents: "initial" });
  $itemSelectors.$itemByKey(itemKEY).css({ opacity: 1 });
}

function cartPopupItemMaxQuantityReached(item) {
  alert(`All ${item.title} are in your cart.`)
}

function cartPopupCheckIfItemExists(item) {

  return $itemSelectors.$itemByKey(item.key).length
   
 // return $itemSelectors.$item(item.id).length;
}

function cartPopupShowEvent(event) {
  event.preventDefault();
  cart.items.length ? setCartPopupWithItems() : setCartPopupBlank();

  cartPopupProgressBarSetCalculating();
  showCartPopup();

  cartPopupIsUpsellEmpty(upsellItemsInCart, upsellItemsAvailable) &&
    $(document).trigger(cartEvents.upsell.upsellIsEmpty);

  
  /// On first open
  
    calculateCartSubtotal(); 
    calculateCartTotal();

    updateCartPopupSubtotal();
    updateCartPopupShipping();
    updateCartPopupTotal();
  ////////////////////////////
  calculateCartTotals();
  updateCartTotals();
 

  //cartPopupProgressBarUpdate();
}

window.addEventListener('load', function(event) {
  event.preventDefault();
  if(window.location.hash.indexOf('cart-open') > -1){
    setTimeout(()=>{
      cartPopupShowEvent(event);
    }, 200)
  }
});